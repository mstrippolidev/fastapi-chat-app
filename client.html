<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .chat-scroll::-webkit-scrollbar { width: 6px; }
        .chat-scroll::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 4px; }
        /* Style for disabled state */
        .disabled-controls { opacity: 0.5; pointer-events: none; }
    </style>
</head>
<body class="bg-gray-100 h-screen flex font-sans">

    <!-- SIDEBAR -->
    <aside class="w-1/4 bg-white border-r flex flex-col hidden md:flex">
        <div class="p-4 border-b bg-gray-50 flex justify-between items-center">
            <h2 class="font-bold text-lg text-gray-700">Chats</h2>
            <button onclick="window.location.href='/logout'" class="text-xs text-red-500 hover:underline">Logout</button>
        </div>
        <div id="chat-list" class="flex-1 overflow-y-auto p-2 space-y-2">
            <!-- Chat Items injected here -->
            <div class="text-center text-gray-400 text-sm mt-4">Loading...</div>
        </div>
    </aside>

    <!-- MAIN AREA -->
    <main class="flex-1 flex flex-col">
        <!-- Header -->
        <header class="bg-white border-b p-4 flex justify-between items-center sticky top-0 z-10 shadow-sm">
            <div class="flex items-center gap-4">
                <h1 id="current-chat-title" class="text-lg font-bold text-gray-800">Select a Chat</h1>
                <div id="status-indicator" class="flex items-center gap-2 px-3 py-1 bg-gray-100 rounded-full">
                    <span class="w-2 h-2 rounded-full bg-red-500"></span>
                    <span class="text-xs font-medium text-gray-500">Offline</span>
                </div>
            </div>
            
            <div class="flex items-center gap-2">
                <!-- This input creates a new chat via the API -->
                <input type="text" id="new-chat-recipient" placeholder="Start new chat (User ID)" 
                       class="border p-2 rounded-full text-sm w-48 focus:ring-2 focus:ring-blue-500 outline-none px-4"
                       onkeypress="handleNewChatEnter(event)">
            </div>
        </header>

        <!-- Messages -->
        <div id="messages" class="flex-1 p-4 overflow-y-auto chat-scroll space-y-3 bg-gray-50">
            <div class="text-center text-gray-400 mt-10">Select a chat from the sidebar to start messaging.</div>
        </div>

        <!-- Input Area (Wrapped in a div ID for easy disabling) -->
        <div id="chat-controls" class="bg-white p-4 border-t flex gap-3 items-center disabled-controls transition-opacity duration-200">
            <input type="file" id="file-input" class="hidden" onchange="handleFileSelect(this)">
            
            <button id="upload-btn" onclick="uploadFile()" class="p-2 text-gray-500 hover:bg-gray-100 rounded-full disabled:cursor-not-allowed">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13" /></svg>
            </button>
            
            <input type="text" id="message-input" placeholder="Type a message..." disabled
                   class="flex-1 bg-gray-100 border-0 p-3 rounded-full focus:ring-2 focus:ring-blue-500 outline-none disabled:bg-gray-200" 
                   onkeypress="handleEnter(event)">
            
            <button id="send-btn" onclick="sendMessage()" disabled 
                    class="bg-blue-600 text-white px-6 py-2 rounded-full font-semibold hover:bg-blue-700 transition disabled:bg-gray-400 disabled:cursor-not-allowed">
                Send
            </button>
        </div>
    </main>

    <script>
        const CONFIG = {
            wsUrl: "ws://localhost:8000/ws",
            bucketName: "websocket-fastapi-tutorial-1"
        };

        let socket = null;
        let currentChatId = null;
        let currentRecipientId = null; // Store the recipient ID
        let myUserId = null; 
        let myUsername = null;

        window.addEventListener('load', async () => {
            // Ensure controls are disabled on load
            toggleChatControls(false);
            
            await fetchMe();
            await loadActiveChats();
            connectWebSocket();
        });

        // Toggle helper
        function toggleChatControls(enable) {
            const container = document.getElementById("chat-controls");
            const input = document.getElementById("message-input");
            const sendBtn = document.getElementById("send-btn");
            const uploadBtn = document.getElementById("upload-btn");

            if (enable) {
                container.classList.remove("disabled-controls");
                input.disabled = false;
                sendBtn.disabled = false;
                uploadBtn.disabled = false;
                input.focus();
            } else {
                container.classList.add("disabled-controls");
                input.disabled = true;
                sendBtn.disabled = true;
                uploadBtn.disabled = true;
            }
        }

        async function fetchMe() {
            try {
                const res = await fetch('/api/me');
                if (res.ok) {
                    const user = await res.json();
                    myUserId = user.user_id;
                    myUsername = user.username;
                }
            } catch (e) { console.error(e); }
        }

        async function loadActiveChats() {
            try {
                const res = await fetch('/api/chats');
                if (!res.ok) return;
                const chats = await res.json();
                
                const listEl = document.getElementById("chat-list");
                listEl.innerHTML = "";
                
                chats.forEach(chat => {
                    const div = document.createElement("div");
                    div.className = "p-3 hover:bg-blue-50 cursor-pointer rounded-lg transition border-b border-gray-100 mb-1";
                    div.onclick = () => selectChat(chat);
                    
                    const otherUser = chat.participants_username.find(p => p !== myUsername) || "Chat";
                    
                    div.innerHTML = `
                        <div class="font-bold text-gray-800 text-sm truncate">${otherUser}</div>
                        <div class="text-xs text-gray-500 truncate">${chat.last_message || '...'}</div>
                    `;
                    listEl.appendChild(div);
                });
            } catch (e) { console.error(e); }
        }

        async function selectChat(chat) {
            currentChatId = chat.chat_id;
            
            // Find who the other person is in this chat
            const otherUser = chat.participants_user_ids.find(p => p !== myUserId);
            const otherUsername = chat.participants_username.find(p => p !== myUsername);
            
            if (otherUser) {
                currentRecipientId = otherUser;
                document.getElementById("current-chat-title").innerText = otherUsername;
                // Enable inputs now that we have a valid target
                toggleChatControls(true);
            } else {
                console.error("Could not find recipient in chat participants");
                return;
            }

            const msgsDiv = document.getElementById("messages");
            msgsDiv.innerHTML = '<div class="text-center text-gray-400 mt-4">Loading history...</div>';
            
            try {
                const res = await fetch(`/api/chats/${chat.chat_id}/messages`);
                if (res.ok) {
                    const messages = await res.json();
                    msgsDiv.innerHTML = "";
                    messages.forEach(msg => displayMessage(msg));
                }
            } catch (e) { msgsDiv.innerHTML = "Error loading history."; }
        }

        function connectWebSocket() {
            socket = new WebSocket(CONFIG.wsUrl);
            socket.onopen = () => updateStatus(true, "Online");
            socket.onmessage = (event) => {
                const msg = JSON.parse(event.data);
                if (msg.type === "error") {
                    alert(msg.content); // Popup error
                    if (msg.code === "001") {
                        // Code 001 = Limit Reached -> Disable Input
                        toggleChatControls(false);
                    }
                    return; 
                }
                if (msg.type === "file_upload_url") { handleActualUpload(msg); return; }
                
                if (currentChatId && msg.chat_id === currentChatId) {
                    displayMessage(msg);
                }
                loadActiveChats(); 
            };
            socket.onclose = () => updateStatus(false, "Disconnected");
        }
        function isImageFile(filename) {
            return /\.(jpg|jpeg|png|gif|webp|bmp)$/i.test(filename);
        }
        // --- UPDATED DISPLAY LOGIC ---
        function displayMessage(msg) {
            const messagesDiv = document.getElementById("messages");
            const msgEl = document.createElement("div");
            
            const isMe = (msg.sender_id === myUserId);
            const align = isMe ? "items-end" : "items-start";
            const bubble = isMe ? "bg-blue-600 text-white rounded-br-none" : "bg-white border text-gray-800 rounded-bl-none";
            
            let contentHtml = `<p>${msg.content}</p>`;
            
            if (msg.type === "file") {
                const downloadUrl = msg.file_url || "#";
                // Attempt to find filename from msg, or extract from the S3 key (msg.content)
                let filename = msg.filename;
                if (!filename && msg.content) {
                    filename = msg.content.split('/').pop(); // Extract "uuid-image.jpg" from path
                }
                filename = filename || "File";

                // CHECK IF IT IS AN IMAGE
                if (isImageFile(filename)) {
                    // Render as IMAGE
                    contentHtml = `
                        <div class="flex flex-col gap-1">
                            <a href="${downloadUrl}" target="_blank" title="Click to view full size">
                                <img src="${downloadUrl}" alt="${filename}" class="rounded-lg max-w-[200px] max-h-[200px] object-cover border border-white/20">
                            </a>
                        </div>
                    `;
                } else {
                    // Render as GENERIC FILE DOWNLOAD
                    contentHtml = `
                        <a href="${downloadUrl}" target="_blank" class="underline flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                            ${filename}
                        </a>`;
                }
            }

            msgEl.className = `flex flex-col ${align}`;
            msgEl.innerHTML = `
                <div class="${bubble} px-4 py-2 rounded-2xl shadow-sm max-w-[80%] text-sm">
                    ${contentHtml}
                </div>
                <span class="text-[10px] text-gray-400 mt-1 mx-1">${msg.username || 'User'}</span>
            `;
            messagesDiv.appendChild(msgEl);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // --- NEW CHAT LOGIC ---
        async function handleNewChatEnter(e) {
            if (e.key !== 'Enter') return;
            const recipientId = document.getElementById("new-chat-recipient").value.trim();
            if (!recipientId) return;

            try {
                const res = await fetch('/api/chats', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ recipient_id: recipientId })
                });
                if (res.ok) {
                    const data = await res.json();
                    document.getElementById("new-chat-recipient").value = "";
                    loadActiveChats(); // Reload sidebar
                } else {
                    alert("User not found or error creating chat");
                }
            } catch(e) { console.error(e); }
        }

        // --- SENDING LOGIC (Updated to use BOTH IDs) ---
        function sendMessage() {
            const input = document.getElementById("message-input");
            const content = input.value.trim();
            
            if (!currentChatId || !currentRecipientId || !content) return;
            
            socket.send(JSON.stringify({ 
                type: "chat", 
                chat_id: currentChatId, 
                recipient_id: currentRecipientId,
                content: content 
            }));
            
            input.value = "";
        }
        
        function handleEnter(e) { if(e.key === 'Enter') sendMessage(); }
        
        function updateStatus(c, t) {
            const el = document.getElementById("status-indicator");
            el.querySelector("span:last-child").innerText = t;
            el.querySelector("span:first-child").className = c ? "w-2 h-2 rounded-full bg-green-500" : "w-2 h-2 rounded-full bg-red-500";
        }
        
        function uploadFile() { document.getElementById("file-input").click(); }
        
        function handleFileSelect(input) { 
            if(input.files.length > 0) {
                 const f = input.files[0];
                 if(!currentChatId || !currentRecipientId) return alert("Select chat first");
                 
                 socket.send(JSON.stringify({ 
                     type: "file_request", 
                     chat_id: currentChatId,
                     recipient_id: currentRecipientId, // Sending BOTH
                     filename: f.name, 
                     filesize: f.size 
                 }));
            }
        }
        
        async function handleActualUpload(msg) {
             const fileInput = document.getElementById("file-input");
             if (!fileInput.files.length) return;
             const file = fileInput.files[0];
             
             try {
                 await fetch(msg.url, { method: "PUT", body: file });
                 
                 socket.send(JSON.stringify({
                     type: "file_uploaded",
                     chat_id: currentChatId, 
                     recipient_id: currentRecipientId, // Sending BOTH
                     filename: msg.filename,
                     s3_key: msg.s3_key
                 }));
                 fileInput.value = ""; // Reset
             } catch (e) { console.error("Upload failed", e); }
        }
    </script>
</body>
</html>