<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .chat-scroll::-webkit-scrollbar { width: 6px; }
        .chat-scroll::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 4px; }
    </style>
</head>
<body class="bg-gray-50 h-screen flex flex-col font-sans">

    <!-- Header -->
    <header class="bg-white border-b p-4 flex justify-between items-center sticky top-0 z-10">
        <div class="flex items-center gap-4">
            <h1 class="text-lg font-bold text-gray-800">Chat</h1>
            <div id="status-indicator" class="flex items-center gap-2 px-3 py-1 bg-gray-100 rounded-full">
                <span class="w-2 h-2 rounded-full bg-red-500 transition-colors duration-300"></span>
                <span class="text-xs font-medium text-gray-500">Connecting...</span>
            </div>
        </div>
        
        <div class="flex items-center gap-2">
            <!-- Login Button REMOVED -->
            <input type="text" id="recipient-id" placeholder="Recipient User ID" class="border p-2 rounded text-sm w-40 focus:ring-2 focus:ring-blue-500 outline-none">
        </div>
    </header>

    <!-- Messages / Main Area -->
    <div id="messages" class="flex-1 p-4 overflow-y-auto chat-scroll space-y-4">
        <div id="welcome-msg" class="text-center text-gray-400 text-sm mt-10">
            Connecting to secure server...
        </div>
    </div>

    <!-- Controls -->
    <div class="bg-white p-4 border-t flex gap-3 items-center sticky bottom-0">
        <input type="file" id="file-input" class="hidden" onchange="handleFileSelect(this)">
        <button onclick="uploadFile()" class="bg-gray-100 text-gray-600 p-3 rounded-full hover:bg-gray-200 transition">
             <!-- Icon -->
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13" /></svg>
        </button>
        <input type="text" id="message-input" placeholder="Type a message..." class="flex-1 bg-gray-50 border border-gray-200 p-3 rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500" onkeypress="handleEnter(event)">
        <button onclick="sendMessage()" class="bg-blue-600 text-white p-3 px-6 rounded-full hover:bg-blue-700 font-bold transition">Send</button>
    </div>

    <script>
        const CONFIG = {
            // cognitoDomain removed as it's no longer needed here
            wsUrl: "ws://localhost:8000/ws",
            bucketName: "websocket-fastapi-tutorial-1"
        };

        let socket = null;
        let currentUserId = "Me"; 

        // Login function REMOVED

        function connectWebSocket() {
            // No token in URL! Browser sends the cookie automatically.
            socket = new WebSocket(CONFIG.wsUrl);

            socket.onopen = () => {
                updateStatus(true, "Online");
                document.getElementById("welcome-msg").classList.add("hidden");
            };
            
            socket.onmessage = (event) => {
                const msg = JSON.parse(event.data);
                processIncomingMessage(msg);
            };
            
            socket.onclose = (e) => {
                // Simplified close logic
                updateStatus(false, "Disconnected");
                console.log("Connection closed", e.code, e.reason);
            };
        }

        function updateStatus(isConnected, msg) {
            const indicator = document.getElementById("status-indicator");
            indicator.querySelector("span:last-child").innerText = msg;
            indicator.querySelector("span:first-child").className = isConnected ? 
                "w-2 h-2 rounded-full bg-green-500 shadow-[0_0_8px_rgba(34,197,94,0.6)]" : 
                "w-2 h-2 rounded-full bg-red-500";
        }

        // --- Chat & File Logic (Same as before) ---
        function sendMessage() {
            const input = document.getElementById("message-input");
            const recipient = document.getElementById("recipient-id").value;
            const content = input.value.trim();
            if (!recipient || !content) return;

            socket.send(JSON.stringify({ type: "chat", recipient_id: recipient, content: content }));
            input.value = "";
        }

        function processIncomingMessage(msg) {
            if (msg.type === "file_upload_url") { handleActualUpload(msg); return; }
            displayMessage(msg);
        }

        function displayMessage(msg) {
            const messagesDiv = document.getElementById("messages");
            const msgEl = document.createElement("div");
            let align = "items-start";
            let bubble = "bg-white border border-gray-200 text-gray-800 rounded-tl-none";
            
            // Since we can't read our own user ID from the cookie in JS,
            // we rely on the message "sender_id" logic.
            // Ideally, you add a REST endpoint /users/me to get your own ID.
            if (msg.sender_id && msg.sender_id === currentUserId) {
                // For now, this alignment logic might be imperfect without /users/me
                align = "items-end"; 
            }
            
            // (Rest of display logic is identical to previous version)
            // ... 
             let contentHtml = `<p>${msg.content}</p>`;
             if (msg.type === "file") {
                const fileUrl = `https://${CONFIG.bucketName}.s3.amazonaws.com/${msg.s3_key}`;
                contentHtml = `<a href="${fileUrl}" target="_blank" class="text-blue-600 underline">File: ${msg.filename}</a>`;
             }

            msgEl.className = `flex flex-col ${align}`;
            msgEl.innerHTML = `<div class="${bubble} p-3 rounded-xl shadow-sm max-w-[80%]">${contentHtml}</div>`;
            messagesDiv.appendChild(msgEl);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
        
        // --- File Upload Logic (Same as before) ---
        function uploadFile() { document.getElementById("file-input").click(); }
        function handleFileSelect(input) {
             // ... (Previous logic)
             if (input.files.length > 0) {
                const currentFile = input.files[0];
                const recipient = document.getElementById("recipient-id").value;
                socket.send(JSON.stringify({ type: "file_request", filename: currentFile.name, filesize: currentFile.size }));
             }
        }
        
        async function handleActualUpload(msg) {
             // ... (Previous upload logic)
             // Note: We need access to 'currentFile' here, ensure it's scoped correctly
        }

        // Start
        connectWebSocket();

    </script>
</body>
</html>